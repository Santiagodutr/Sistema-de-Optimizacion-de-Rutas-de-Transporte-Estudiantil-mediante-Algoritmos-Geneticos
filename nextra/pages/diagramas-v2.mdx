import { Callout } from 'nextra/components'

# Diagramas Actualizados v2.0

Documentaci√≥n completa de los diagramas UML del sistema actualizado con integraci√≥n de **Google Gemini AI**.

## üÜï Cambios en v2.0

El sistema ha sido actualizado para incluir an√°lisis autom√°tico con inteligencia artificial:

- **Nuevo endpoint:** `/api/analisis-ia` en el Backend
- **Nueva clase:** `GeminiAIAnalyzer` para procesamiento con Gemini
- **Nuevo componente:** `AIAnalysisModal.jsx` en el Frontend
- **Nueva estructura:** `AnalisisIA` para datos de an√°lisis
- **Nuevos casos de uso:** 3 nuevos casos relacionados con an√°lisis IA

<Callout type="info">
  Los diagramas de esta secci√≥n est√°n en formato **PlantUML** y pueden visualizarse
  en [PlantUML Online Editor](http://plantuml.com/plantuml/uml/). Simplemente copia
  el contenido del diagrama y p√©galo en el editor.
</Callout>

## üìã Casos de Uso v2.0

### Resumen de cambios

El diagrama de casos de uso ahora incluye:

- **UC26:** Generar an√°lisis con Google Gemini
- **UC27:** Construir prompt detallado
- **UC28:** Interpretar resultados del GA
- **UC29:** Generar recomendaciones
- **UC30:** Renderizar an√°lisis en Markdown
- **UC31:** Exportar an√°lisis (copiar/descargar)

### Nuevo actor

- `Google Gemini AI` - API de Google para an√°lisis inteligente

### Relaciones principales

```
UC20 (Mejor ruta) ‚Üí UC26 (An√°lisis IA)
UC26 ‚Üí Gemini API
UC26 ‚Üí UC27 ‚Üí UC28 ‚Üí UC29 ‚Üí UC30 ‚Üí UC31 (Flujo de an√°lisis)
```

### Caracter√≠sticas

- **Prompt contextualizado:** Incluye datos de ruta, par√°metros del AG e historial de fitness
- **An√°lisis completo:** Resumen, explicaci√≥n, recomendaciones y conclusiones
- **Exportaci√≥n:** Copiar al portapapeles o descargar como Markdown

## üèóÔ∏è Diagrama de Clases v2.0

### Nueva clase: GeminiAIAnalyzer

```python
class GeminiAIAnalyzer {
    - api_key: str
    - modelo: str = "gemini-2.0-flash"
    - cliente_gemini: genai.GenerativeModel
    
    + __init__(api_key)
    + construir_prompt(datos_ruta, resultados)
    + generar_analisis(prompt)
    + interpretar_resultados(json)
    + generar_recomendaciones(analisis)
    + formatear_markdown(analisis_raw)
}
```

### Nueva estructura de datos: AnalisisIA

```python
class AnalisisIA {
    - resumen_ejecutivo: str
    - explicacion_algoritmo: str
    - analisis_parametros: str
    - recomendaciones: list[str]
    - conclusiones: str
    - markdown_completo: str
}
```

### Nuevo componente React: AIAnalysisModal

```javascript
class AIAnalysisModal {
    - analisis: string
    - markdown: JSX.Element
    - cargando: boolean
    - onClose: function
    
    + render(): JSX.Element
    + renderMarkdown(texto): JSX.Element
    + copiarAlPortapapeles(): void
    + descargarComoMarkdown(): void
    + handleCerrar(): void
}
```

### Cambios en clases existentes

**FlaskAPI:**
```python
+ analizar_con_ia(resultados_ga) -> dict  # Nuevo m√©todo
```

**App (React):**
```javascript
- modalIA: boolean              # Nuevo state
- analisisIA: AnalisisIA?       # Nuevo state

+ generarAnalisisIA(): void     # Nuevo m√©todo
+ cerrarModalIA(): void         # Nuevo m√©todo
```

**ApiClient:**
```javascript
+ generarAnalisisIA(datos): Promise  # Nuevo m√©todo
```

## üîÑ Secuencia de An√°lisis IA

### Flujo detallado (12 pasos)

1. **Usuario inicia:** Hace clic en "Generar An√°lisis IA"
2. **Frontend prepara:** Desactiva bot√≥n, muestra spinner
3. **Env√≠o de datos:** POST /api/analisis-ia con resultados del GA
4. **Validaci√≥n Backend:** Recibe y valida datos
5. **Construcci√≥n de Prompt:** Backend construye prompt contextualizado
   - Datos de paradas
   - Par√°metros del AG
   - Historial de fitness
   - Estad√≠sticas
6. **Llamada a Gemini:** POST a Google Gemini 2.0 Flash
7. **Procesamiento IA:** Google Gemini analiza con inteligencia artificial
8. **Generaci√≥n de an√°lisis:** Crea contenido Markdown con:
   - Resumen ejecutivo
   - Explicaci√≥n del algoritmo
   - An√°lisis de par√°metros
   - Recomendaciones
   - Conclusiones
9. **Respuesta del Backend:** Retorna an√°lisis formateado
10. **Renderizado:** Frontend renderiza Markdown en modal
11. **Interacci√≥n del usuario:** Puede copiar o descargar
12. **Cierre:** Usuario cierra modal

**Tiempo t√≠pico:** 3-5 segundos

## üèõÔ∏è Arquitectura del Sistema v2.0

### Capas del sistema

**Frontend (React - Puerto 3000)**
- RouteSelector
- MapView (Leaflet)
- GeneticAlgorithmPanel
- AlgorithmProcedurePanel
- **AIAnalysisModal (NUEVO)**

**API REST (Flask - Puerto 5000)**
- `/api/health`
- `/api/rutas/info`
- `/api/rutas/optimizar`
- **`/api/analisis-ia` (NUEVO)**

**Backend Processing (Python)**
- Gesti√≥n de Datos
- C√°lculo de Distancias
- Optimizaci√≥n (AG)
- **An√°lisis con IA (NUEVO)**

**Cach√© (Triple nivel)**
- Coordenadas geocodificadas
- Matrices de distancias
- Geometr√≠as de calles

**Datos Persistentes (JSON)**
- rutas_reales.json (11 rutas, 150+ paradas)
- coordenadas_exactas.py (150+ paraderos)

**Servicios Externos**
- OpenStreetMap (red vial)
- Nominatim (geocoding)
- **Google Gemini 2.0 Flash (NUEVO)**

### Flujos principales

```
Usuario ‚Üí Frontend ‚Üí API REST ‚Üí Backend
                                  ‚îú‚Üí DataLoader
                                  ‚îú‚Üí CalculadoraDistancias
                                  ‚îú‚Üí GeneticAlgorithm
                                  ‚îî‚Üí GeminiAIAnalyzer (NEW) ‚Üí Gemini API
```

## üìä Flujo Principal del Sistema v2.0

### Pasos generales

1. **Inicio:** Usuario accede al sistema (localhost:3000)
2. **Validaci√≥n:** Sistema verifica estado del Backend
3. **Carga:** Obtiene lista de rutas disponibles
4. **Selecci√≥n:** Usuario selecciona rutas y par√°metros del AG
5. **Optimizaci√≥n:** Backend ejecuta algoritmo gen√©tico
   - Geocodifica paraderos
   - Descarga red vial de OSM
   - Calcula matriz de distancias
   - Evoluciona poblaci√≥n
6. **Resultados:** Frontend muestra ruta optimizada en mapa
7. **An√°lisis (NUEVO):** Usuario puede generar an√°lisis con IA
8. **Modal:** Se abre modal con an√°lisis Markdown
9. **Exportaci√≥n:** Usuario puede copiar o descargar an√°lisis
10. **Finalizaci√≥n:** Usuario termina o realiza otra optimizaci√≥n

### Decisiones clave

- ¬øBackend disponible? ‚Üí Si no, muestra error
- ¬øCoords en cach√©? ‚Üí Si s√≠, evita geocodificaci√≥n
- ¬øUsuario quiere an√°lisis? ‚Üí Si s√≠, inicia proceso de IA
- ¬øGemini disponible? ‚Üí Si no, muestra error

## üìà Comparaci√≥n v1.0 vs v2.0

| Aspecto | v1.0 | v2.0 | Cambio |
|--------|------|------|--------|
| **Casos de Uso** | 28 | 31 | +3 (+10.7%) |
| **Clases Backend** | 6 | 7 | +1 (GeminiAIAnalyzer) |
| **Clases Frontend** | 7 | 8 | +1 (AIAnalysisModal) |
| **Estructuras Datos** | 6 | 7 | +1 (AnalisisIA) |
| **Endpoints API** | 3 | 4 | +1 (/api/analisis-ia) |
| **APIs Externas** | 2 | 3 | +1 (Google Gemini) |
| **An√°lisis** | Manual | Autom√°tico con IA | ‚ú® Nuevo |
| **UI Modal** | No | S√≠ | ‚ú® Nuevo |

## üîß Especificaciones T√©cnicas - IA

### Google Gemini Integration

- **Modelo:** `gemini-2.0-flash`
- **Velocidad:** ~1-3 segundos por an√°lisis
- **Tokens:** ~500-1000 tokens entrada/salida
- **Coste:** ~$0.10 USD por 1M tokens entrada

### Estructura de Prompt

```markdown
# An√°lisis de Optimizaci√≥n de Rutas

## Contexto
- Rutas analizadas: X
- Paradas totales: Y
- Distancia mejorada: Z%

## Datos del Algoritmo Gen√©tico
- Poblaci√≥n: 100
- Generaciones: 200
- Par√°metros: [...]

## Historial de Fitness
[Evoluci√≥n de fitness]

## Solicitud
Proporciona an√°lisis en:
1. Resumen ejecutivo
2. Explicaci√≥n del algoritmo
3. An√°lisis de par√°metros
4. Recomendaciones
5. Conclusiones
```

## üìö Archivos de Diagramas

Los archivos PlantUML se encuentran en:
```
backend/documentos/
‚îú‚îÄ‚îÄ diagrama_casos_uso.puml ‚Üê ACTUALIZADO
‚îú‚îÄ‚îÄ diagrama_clases_v2.puml ‚Üê ACTUALIZADO (nuevo)
‚îú‚îÄ‚îÄ diagrama_arquitectura_v2.puml ‚Üê ACTUALIZADO (nuevo)
‚îú‚îÄ‚îÄ diagrama_flujo_v2.puml ‚Üê ACTUALIZADO (nuevo)
‚îú‚îÄ‚îÄ diagrama_secuencia_analisis_ia.puml ‚Üê NUEVO
‚îî‚îÄ‚îÄ DIAGRAMAS_ACTUALIZADOS_V2.md ‚Üê Documentaci√≥n
```

## üöÄ C√≥mo usar los diagramas

### Opci√≥n 1: PlantUML Online
1. Visita [PlantUML Online Editor](http://plantuml.com/plantuml/uml/)
2. Copia el contenido del archivo .puml
3. Pega en el editor
4. Visualiza el diagrama

### Opci√≥n 2: Visual Studio Code
1. Instala la extensi√≥n "PlantUML" (jebbs.plantuml)
2. Abre el archivo .puml
3. Presiona `Alt+D` para previsualizar

### Opci√≥n 3: Generar imagen
```bash
# Instalar plantuml (requiere Java)
sudo apt-get install plantuml

# Generar PNG
plantuml backend/documentos/diagrama_casos_uso.puml

# Generar SVG
plantuml -tsvg backend/documentos/diagrama_casos_uso.puml
```

## ‚úÖ Validaci√≥n

- [x] Casos de Uso actualizados
- [x] Diagrama de Clases v2.0
- [x] Secuencia de An√°lisis IA
- [x] Arquitectura actualizada
- [x] Flujo Principal actualizado
- [x] Documentaci√≥n completa

## üìù Notas importantes

<Callout type="warning">
  **API Key de Google Gemini:** Debe configurarse como variable de entorno:
  ```bash
  export GOOGLE_API_KEY="tu_api_key_aqui"
  ```
</Callout>

<Callout type="info">
  **Conexi√≥n a Internet:** Requerida para todas las operaciones que incluyan Google Gemini.
</Callout>

<Callout type="info">
  **Rate Limiting:** Google Gemini tiene l√≠mites:
  - Free tier: 60 solicitudes/minuto
  - Pagado: L√≠mites mayores
</Callout>

## üìû Soporte

Para m√°s informaci√≥n sobre los diagramas:
1. Consulta `backend/documentos/DIAGRAMAS_ACTUALIZADOS_V2.md`
2. Revisa la [documentaci√≥n de PlantUML](https://plantuml.com/)
3. Consulta la [documentaci√≥n de Google Gemini](https://ai.google.dev/)

---

**Versi√≥n:** 2.0  
**√öltima actualizaci√≥n:** 2024  
**Estado:** ‚úÖ Documentaci√≥n completa
