@startuml Diagrama de Clases - Sistema Optimización de Rutas v2.0 (Con IA)

!theme plain
skinparam backgroundColor #FEFEFE
skinparam classBackgroundColor #F0F0F0
skinparam classBorderColor #333
```plantuml
@startuml Diagrama de Módulos - Backend (Python)

!theme plain
skinparam backgroundColor #FEFEFE
skinparam classBackgroundColor #F0F0F0
skinparam classBorderColor #333
skinparam arrowColor #333

' === MÓDULOS / COMPONENTES DEL BACKEND ===

package "Backend - Python (Flask)" {

    class api_rutas_reales {
        + health_check()
        + obtener_info_rutas()
        + optimizar_rutas_reales()
        + analisis_ia()
        - cache_coordenadas
        - cache_matrices
        - cache_geometrias
        - GEMINI_API_KEY
        - gemini_client
    }

    class data_loader {
        + obtener_coordenadas(direcciones)
        + matriz_distancias_osm_con_geometria(coordenadas)
        + matriz_distancias_osm(coordenadas)
    }

    class rutas_loader {
        + cargar_rutas_reales()
        + obtener_todas_las_paradas()
        + obtener_paradas_por_ruta(ruta_id)
        + obtener_info_ruta(ruta_id)
        + obtener_todas_las_rutas()
        + crear_asignacion_buses_por_ruta()
    }

    class genetic_algorithm {
        + crear_individuo(n_paradas, punto_inicio_idx=0, punto_fin_idx=None)
        + crear_poblacion(tamano_poblacion, n_paradas, punto_inicio_idx=0, punto_fin_idx=None)
        + seleccion_torneo(poblacion, fitness_poblacion, k=3)
        + cruce_pmx(padre1, padre2)
        + mutacion_intercambio(individuo, tasa_mutacion=0.1)
        + algoritmo_genetico(matriz_distancias, punto_inicio_idx=0, punto_fin_idx=None, tamano_poblacion=100, generaciones=200, tasa_cruce=0.8, tasa_mutacion=0.15, elitismo=2, verbose=True)
    }

    class fitness {
        + calcular_fitness(ruta, matriz_distancias)
        + evaluar_poblacion(poblacion, matriz_distancias)
        + calcular_fitness_con_penalizacion(ruta, matriz_distancias, capacidad_bus=50, demanda_paradas=None)
    }

    class coordenadas_exactas {
        + COORDENADAS_EXACTAS
        + buscar_coordenada_exacta(direccion)
    }

}

' === RELACIONES (uso / dependencia) ===

api_rutas_reales --> rutas_loader : cargar rutas
api_rutas_reales --> data_loader : geocodificar / calcular matriz y geometrías
api_rutas_reales --> genetic_algorithm : ejecutar algoritmo_genetico
genetic_algorithm --> fitness : evaluar_poblacion / calcular_fitness
data_loader --> coordenadas_exactas : buscar_coordenada_exacta
api_rutas_reales ..> genai : usa cliente Gemini (si está configurado)

' === NOTAS RELEVANTES ===

note right of api_rutas_reales #FFEECC
  Endpoints principales (archivo: `api_rutas_reales.py`):
  - `GET /api/health` -> `health_check()`
  - `GET /api/rutas/info` -> `obtener_info_rutas()`
  - `GET /api/rutas/optimizar` -> `optimizar_rutas_reales()` (parámetros GA en querystring)
  - `POST /api/analisis-ia` -> `analisis_ia()` (envía datos a Gemini)
  Variables globales de caché: `cache_coordenadas`, `cache_matrices`, `cache_geometrias`.
end note

note left of data_loader #DDFFDD
  `data_loader.py` usa OSMnx y Geopy para:
  - geocodificar direcciones (`obtener_coordenadas`)
  - construir matriz de distancias y geometrías reales (`matriz_distancias_osm_con_geometria`)
end note

note left of genetic_algorithm #DDDDFF
  `genetic_algorithm.py` implementa:
  - Selección por torneo, Cruce PMX, Mutación por intercambio
  - Retorna `{'mejor_ruta', 'mejor_fitness', 'historial_fitness', 'historial_detallado'}`
end note

note bottom of coordenadas_exactas #FFEEDD
  Diccionario `COORDENADAS_EXACTAS` con paradas predefinidas
  `buscar_coordenada_exacta()` intenta coincidencias exactas y parciales
end note

@enduml
```
        + formatear_markdown(analisis_raw) -> str [NEW]
