@startuml Diagrama de Clases - Sistema Optimización de Rutas v2.0 (Con IA)

!theme plain
skinparam backgroundColor #FEFEFE
skinparam classBackgroundColor #F0F0F0
skinparam classBorderColor #333
skinparam arrowColor #333

' === CLASES DEL BACKEND (Python) ===

package "Backend - Python (Flask)" {
    
    class FlaskAPI {
        - app: Flask
        - datos_rutas: dict
        - geocoder: Geocoder
        - network: nx.MultiDiGraph
        - cache: CacheManager
        --
        + __init__()
        + cargar_rutas()
        + health_check() -> dict
        + obtener_info_rutas() -> dict
        + optimizar_rutas(ruta_ids?) -> dict
        + analizar_con_ia(resultados_ga) -> dict [NEW]
        + setup_cache()
    }
    
    class DataLoader {
        - archivo_rutas: str
        - encoder: LabelEncoder
        --
        + cargar_datos() -> dict
        + validar_datos() -> bool
        + obtener_rutas() -> list
        + obtener_paradas(ruta_id) -> list
        + obtener_primera_parada(ruta_id) -> dict
    }
    
    class CoordenadaHandler {
        - coordenadas_exactas: dict
        - geocoder: Geocoder
        - cache: CacheManager
        --
        + obtener_coordenadas(direccion) -> (lat, lon)
        + geocodificar(lista_direcciones) -> list
        + procesar_coordenadas() -> list
        + usar_cache(direccion) -> (lat, lon)?
        + guardar_en_cache(direccion, coords)
    }
    
    class CalculadoraDistancias {
        - network: nx.MultiDiGraph
        - matriz_distancias: dict
        - geometrias: dict
        - cache: CacheManager
        --
        + descargar_red_osm(ciudad, redes) -> nx.MultiDiGraph
        + calcular_matriz_distancias(coords) -> ndarray
        + calcular_geometria_rutas(coords) -> list
        + obtener_del_cache(coords_hash) -> ndarray?
        + guardar_en_cache(coords_hash, matriz)
    }
    
    class GeneticAlgorithm {
        - poblacion_size: int
        - num_generaciones: int
        - tasa_cruce: float
        - tasa_mutacion: float
        - torneo_k: int
        - elitismo: int
        - matriz_distancias: ndarray
        - paradas: list
        - historial_fitness: list
        --
        + __init__(params)
        + crear_poblacion() -> list
        + evaluar_poblacion(poblacion) -> list
        + seleccion_torneo(poblacion, fitness) -> list
        + cruce_pmx(padre1, padre2) -> tuple
        + mutacion_intercambio(individuo) -> list
        + evolucionar() -> (best, historial)
        + aplicar_elitismo(poblacion, elite)
    }
    
    class FitnessCalculator {
        - matriz_distancias: ndarray
        - paradas_por_ruta: dict
        - pesos: dict
        --
        + calcular_fitness(ruta) -> float
        + calcular_distancia_total(ruta) -> float
        + calcular_tiempo_espera(ruta) -> float
        + calcular_balanceo_paradas(ruta) -> float
        + normalizar_fitness(valor) -> float
    }
    
    class GeminiAIAnalyzer {
        - api_key: str
        - modelo: str
        - cliente_gemini: genai.GenerativeModel
        --
        + __init__(api_key) [NEW]
        + construir_prompt(datos_ruta, resultados) -> str [NEW]
        + generar_analisis(prompt) -> str [NEW]
        + interpretar_resultados(json_resultados) -> dict [NEW]
        + generar_recomendaciones(analisis) -> list [NEW]
        + formatear_markdown(analisis_raw) -> str [NEW]
    }
    
    class CacheManager {
        - almacen: dict
        - tipos: dict
        --
        + guardar(clave, valor, tipo)
        + obtener(clave) -> any?
        + existe(clave) -> bool
        + limpiar_tipo(tipo)
        + limpiar_todo()
        + obtener_stats() -> dict
    }
}

' === CLASES DEL FRONTEND (React) ===

package "Frontend - React (JavaScript)" {
    
    class App {
        - rutas: Ruta[]
        - rutasSeleccionadas: number[]
        - resultados: ResultadosOptimizacion?
        - cargando: boolean
        - modalIA: boolean [NEW]
        - analisisIA: AnalisisIA? [NEW]
        --
        + optimizarRuta(): void
        + generarAnalisisIA(): void [NEW]
        + cerrarModalIA(): void [NEW]
        + seleccionarRutaOptimizada(): void
        + get rutasDisponibles(): Ruta[]
    }
    
    class RouteSelector {
        - rutas: Ruta[]
        - seleccionadas: number[]
        - onChange: function
        --
        + render(): JSX.Element
        + handleSelectRuta(id): void
        + handleSelectAll(): void
        + handleDeselectAll(): void
    }
    
    class MapView {
        - coordenadas: Coordenada[]
        - geometria: GeoJSON?
        - zoom: number
        - centro: Coordenada
        --
        + render(): JSX.Element
        + mostrarRuta(coords): void
        + mostrarGeometria(geojson): void
        + ajustarZoom(): void
    }
    
    class GeneticAlgorithmPanel {
        - poblacion: number
        - generaciones: number
        - tasaCruce: number
        - tasaMutacion: number
        - cargando: boolean
        - onOptimizar: function
        --
        + render(): JSX.Element
        + handleCambioParametro(param, valor): void
        + handleOptimizar(): void
        + mostrarResultados(resultados): void
    }
    
    class AlgorithmProcedurePanel {
        - pasos: PasoAlgoritmo[]
        - actual: number
        - historialFitness: number[]
        --
        + render(): JSX.Element
        + mostrarPaso(numero): void
        + avanzarPaso(): void
        + retrocederPaso(): void
        + graficarFitness(): void
    }
    
    class AIAnalysisModal {
        - analisis: string [NEW]
        - markdown: JSX.Element [NEW]
        - cargando: boolean [NEW]
        - onClose: function [NEW]
        --
        + render(): JSX.Element [NEW]
        + renderMarkdown(texto): JSX.Element [NEW]
        + copiarAlPortapapeles(): void [NEW]
        + descargarComoMarkdown(): void [NEW]
        + handleCerrar(): void [NEW]
    }
    
    class ApiClient {
        - baseURL: string
        - timeout: number
        --
        + getHealth(): Promise
        + getRutasInfo(): Promise
        + optimizarRutas(ids?): Promise
        + generarAnalisisIA(datos): Promise [NEW]
        + handleError(error): void
    }
}

' === ESTRUCTURAS DE DATOS ===

package "Estructuras de Datos" {
    
    class Ruta {
        - id: number
        - nombre: string
        - descripcion: string
        - paradas: Parada[]
        - distancia_km: number
        - tiempo_promedio_min: number
    }
    
    class Parada {
        - id: number
        - nombre: string
        - direccion: string
        - latitud: number
        - longitud: number
        - orden: number
        - horario_salida: string
        - horario_llegada: string
    }
    
    class Individuo {
        - cromosoma: number[]
        - fitness: number
        - distancia: number
        - horarios: string[]
    }
    
    class ResultadosOptimizacion {
        - ruta_original: Ruta
        - ruta_optimizada: Ruta
        - mejora_distancia: number
        - mejora_porcentaje: number
        - matriz_distancias: ndarray
        - geometria: GeoJSON
        - historial_fitness: number[]
        - tiempo_ejecucion: number
    }
    
    class AnalisisIA {
        - resumen_ejecutivo: string [NEW]
        - explicacion_algoritmo: string [NEW]
        - analisis_parametros: string [NEW]
        - recomendaciones: string[] [NEW]
        - conclusiones: string [NEW]
        - markdown_completo: string [NEW]
    }
    
    class Coordenada {
        - latitud: number
        - longitud: number
        - direccion: string
        - accuracy: number
    }
}

' === RELACIONES DE COMPOSICIÓN ===

FlaskAPI *-- DataLoader : usa
FlaskAPI *-- CoordenadaHandler : usa
FlaskAPI *-- CalculadoraDistancias : usa
FlaskAPI *-- GeneticAlgorithm : usa
FlaskAPI *-- GeminiAIAnalyzer : usa [NEW]
FlaskAPI *-- CacheManager : usa

DataLoader *-- Ruta : carga
DataLoader *-- Parada : carga

GeneticAlgorithm *-- Individuo : crea
GeneticAlgorithm *-- FitnessCalculator : usa
GeneticAlgorithm *-- CacheManager : usa

CalculadoraDistancias *-- CacheManager : usa
CoordenadaHandler *-- CacheManager : usa

App *-- RouteSelector : contiene
App *-- MapView : contiene
App *-- GeneticAlgorithmPanel : contiene
App *-- AlgorithmProcedurePanel : contiene
App *-- AIAnalysisModal : contiene [NEW]
App *-- ApiClient : usa

RouteSelector *-- Ruta : maneja
MapView *-- Coordenada : visualiza
GeneticAlgorithmPanel *-- Individuo : muestra

ResultadosOptimizacion *-- Ruta : contiene
ResultadosOptimizacion *-- Coordenada : contiene
AIAnalysisModal *-- AnalisisIA : muestra [NEW]

' === RELACIONES DE DEPENDENCIA ===

FitnessCalculator --> Parada : evalúa
GeneticAlgorithm --> FitnessCalculator : usa

FlaskAPI --> Ruta : retorna
FlaskAPI --> ResultadosOptimizacion : retorna
FlaskAPI --> AnalisisIA : retorna [NEW]

ApiClient --> FlaskAPI : comunica
App --> ApiClient : usa

GeminiAIAnalyzer --> ResultadosOptimizacion : analiza [NEW]
GeminiAIAnalyzer --> AnalisisIA : produce [NEW]

' === NOTAS ===

note right of GeminiAIAnalyzer #FF9966
    **NUEVA CLASE (v2.0)**
    Integración con Google Gemini API
    para análisis automático de
    resultados del algoritmo genético
    
    Modelos: gemini-2.0-flash
end note

note right of AIAnalysisModal #FF9966
    **NUEVO COMPONENTE (v2.0)**
    Modal para visualizar análisis
    generado por IA con:
    - Renderizado de Markdown
    - Copiar al portapapeles
    - Descargar como archivo .md
end note

note right of App
    **NEW en v2.0:**
    - State: modalIA, analisisIA
    - Handler: generarAnalisisIA()
    - Función: cerrarModalIA()
end note

note bottom of GeneticAlgorithm
    **Parámetros configurables:**
    - población: 100
    - generaciones: 200
    - cruce PMX: 0.8
    - mutación: 0.15
    - torneo_k: 3
    - elitismo: 2
end note

note bottom of FitnessCalculator
    **Función multiobjeto:**
    - Distancia total (principal)
    - Tiempo de espera
    - Balanceo de paradas
end note

note left of CalculadoraDistancias
    **Triple caché:**
    - Coordenadas geocodificadas
    - Matrices de distancias
    - Geometrías de rutas
end note

note bottom of CacheManager
    **Tipos de caché:**
    - coordinates
    - distance_matrices
    - geometries
end note

note bottom of ApiClient
    **NEW Endpoint (v2.0):**
    POST /api/analisis-ia
    Genera análisis IA automático
    usando Google Gemini
end note

@enduml
