@startuml Backend - Sistema de Optimización de Rutas

!define FUNC_COLOR #E8F5E9
!define MODULE_COLOR #E3F2FD
!define API_COLOR #FFF3E0

' Módulo de Algoritmo Genético
package "genetic_algorithm.py" <<Module>> MODULE_COLOR {
    class "<<Module>>\ngenetic_algorithm" as GA {
        {static} +crear_individuo(n_paradas: int, punto_inicio_idx: int = 0, punto_fin_idx: int = None): list
        {static} +crear_poblacion(tamano_poblacion: int, n_paradas: int, punto_inicio_idx: int = 0, punto_fin_idx: int = None): list
        {static} +seleccion_torneo(poblacion: list, fitness_poblacion: list, k: int = 3): list
        {static} +cruce_pmx(padre1: list, padre2: list): tuple
        {static} +mutacion_intercambio(individuo: list, tasa_mutacion: float = 0.1): list
        {static} +algoritmo_genetico(matriz_distancias: np.ndarray, punto_inicio_idx: int = 0, punto_fin_idx: int = None, tamano_poblacion: int = 100, generaciones: int = 200, tasa_cruce: float = 0.8, tasa_mutacion: float = 0.15, elitismo: int = 2, verbose: bool = True): dict
    }
    
    note right of GA::algoritmo_genetico
        **Retorna:**
        {
            'mejor_ruta': list,
            'mejor_fitness': float,
            'historial_fitness': list
        }
    end note
}

' Módulo de Fitness
package "fitness.py" <<Module>> MODULE_COLOR {
    class "<<Module>>\nfitness" as Fitness {
        {static} +calcular_fitness(ruta: list, matriz_distancias: np.ndarray): float
        {static} +evaluar_poblacion(poblacion: list, matriz_distancias: np.ndarray): list
        {static} +calcular_fitness_con_penalizacion(ruta: list, matriz_distancias: np.ndarray, capacidad_bus: int = 50, demanda_paradas: list = None): float
    }
}

' Módulo de Carga de Datos
package "data_loader.py" <<Module>> MODULE_COLOR {
    class "<<Module>>\ndata_loader" as DataLoader {
        {static} +obtener_coordenadas(direcciones: list): list
        {static} +matriz_distancias_osm_con_geometria(coordenadas: list): tuple
        {static} +matriz_distancias_osm(coordenadas: list): np.ndarray
    }
    
    note right of DataLoader::matriz_distancias_osm_con_geometria
        **Retorna:**
        (matriz: np.ndarray, geometrias: dict)
        
        geometrias: {(i,j): [(lat,lon), ...]}
    end note
}

' Módulo de Coordenadas Exactas
package "coordenadas_exactas.py" <<Module>> MODULE_COLOR {
    class "<<Module>>\ncoordenadas_exactas" as CoordExactas {
        {static} -COORDENADAS_EXACTAS: dict
        {static} +buscar_coordenada_exacta(direccion: str): tuple
    }
    
    note right of CoordExactas
        **COORDENADAS_EXACTAS:**
        Diccionario con coordenadas
        precisas de paraderos
        {direccion: (lat, lon)}
    end note
}

' Módulo de Carga de Rutas
package "rutas_loader.py" <<Module>> MODULE_COLOR {
    class "<<Module>>\nrutas_loader" as RutasLoader {
        {static} +cargar_rutas_reales(): dict
        {static} +obtener_todas_las_paradas(): list
        {static} +obtener_paradas_por_ruta(ruta_id: int): list
        {static} +obtener_info_ruta(ruta_id: int): dict
        {static} +obtener_todas_las_rutas(): list
        {static} +crear_asignacion_buses_por_ruta(): dict
    }
    
    note right of RutasLoader::crear_asignacion_buses_por_ruta
        **Retorna:**
        {
            bus_id: {
                'bus_id': int,
                'ruta_id': int,
                'nombre_ruta': str,
                'paraderos': list
            }
        }
    end note
}

' API REST con Flask
package "api_rutas_reales.py" <<Flask App>> API_COLOR {
    class "<<Flask>>\napi_rutas_reales" as API {
        {static} -app: Flask
        {static} -cache_coordenadas: dict
        {static} -cache_matrices: dict
        {static} -cache_geometrias: dict
        ..Endpoints..
        {static} +health_check(): Response
        {static} +obtener_info_rutas(): Response
        {static} +optimizar_rutas_reales(): Response
    }
    
    note right of API
        **Endpoints:**
        - GET /api/health
        - GET /api/rutas/info
        - GET /api/rutas/optimizar
        - GET /api/rutas/optimizar?rutas_ids=1,2,3
    end note
    
    note left of API::optimizar_rutas_reales
        **Proceso:**
        1. Carga rutas reales
        2. Obtiene coordenadas (geocoding)
        3. Calcula matriz distancias OSM
        4. Ejecuta algoritmo genético
        5. Retorna rutas optimizadas
    end note
}

' Módulo de Test
package "test_genetic_algorithm.py" <<Test>> #FCE4EC {
    class "<<Test>>\ntest_genetic_algorithm" as Test {
        {static} -matriz_test: np.ndarray
        {static} +main(): void
    }
}

' === RELACIONES ===

' API usa todos los módulos
API ..> GA : <<use>>
API ..> DataLoader : <<use>>
API ..> RutasLoader : <<use>>
API ..> Fitness : <<use>>

' Algoritmo Genético usa Fitness
GA ..> Fitness : <<use>>

' DataLoader usa CoordExactas
DataLoader ..> CoordExactas : <<use>>

' Test usa Algoritmo Genético
Test ..> GA : <<use>>

' Dependencias de librerías externas
note bottom of DataLoader
    **Dependencias:**
    - osmnx (red vial OSM)
    - geopy (geocoding)
    - numpy
end note

note bottom of GA
    **Dependencias:**
    - numpy
    - random
end note

note bottom of API
    **Dependencias:**
    - Flask
    - flask_cors
    - json
    - traceback
end note

@enduml
