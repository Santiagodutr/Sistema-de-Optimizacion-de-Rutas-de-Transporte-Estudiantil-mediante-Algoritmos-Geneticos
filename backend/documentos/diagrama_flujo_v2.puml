@startuml Flujo Principal - Sistema Optimización de Rutas v2.0

start

:Usuario accede al sistema;
note right
    Frontend en localhost:3000
    Backend escuchando en localhost:5000
end note

:Sistema verifica estado\ndel Backend (/api/health);

if (¿Backend disponible?) then (No)
    :Muestra error de conexión;
    stop
else (Sí)
    :Carga lista de rutas disponibles;
    :GET /api/rutas/info;
endif

:Usuario ve panel principal;
note right
    - Selector de rutas
    - Mapa interactivo
    - Panel de parámetros del AG
end note

:Usuario selecciona rutas\na optimizar;

:Usuario ajusta parámetros\n(población, generaciones, etc);
note right
    Parámetros default:
    - Población: 100
    - Generaciones: 200
    - Cruce: 0.8
    - Mutación: 0.15
end note

:Usuario hace clic en\n"Optimizar Rutas";

:Frontend envía solicitud\nPOST /api/rutas/optimizar;

' === Backend Processing ===

:Backend carga rutas reales\ndesde rutas_reales.json;

:Obtiene paradas de rutas\nseleccionadas;

:Intenta geocodificar paraderos;

if (¿Coords en caché local?) then (Sí)
    :Usa coordenadas exactas\nde coordenadas_exactas.py;
    note right
        Base de datos local con
        150+ paraderos predefinidos
    end note
else (No)
    :Consulta Nominatim\n(OpenStreetMap);
    note right
        Rate limit: 1 req/seg
        Fallback: coord aproximada
    end note
endif

:Almacena coordenadas\nen caché de backend;

:Descarga red vial\nde OpenStreetMap (OSM);
note right
    Ciudades: Villavicencio
    Redes: drive, walk
    Uso: networkx graph
end note

:Calcula matriz de distancias\nusando geometría de OSM;
note right
    Distancias reales por calles
    Considera dirección de vías
    Matriz NxN en metros
end note

if (¿Matriz en caché?) then (Sí)
    note right
        Ahorro de tiempo:
        30-60 segundos
    end note
else (No)
    :Almacena matriz en caché;
endif

:Calcula geometría de rutas\n(GeoJSON);
:Almacena geometría en caché;

:Inicializa Algoritmo Genético\ncon parámetros del usuario;

:Crea población inicial\naleatoria;

:Inicia evolución (200 generaciones);

:Para cada generación:
  1. Evalúa fitness de población
  2. Selección por torneo (k=3)
  3. Cruce PMX con tasa 0.8
  4. Mutación por intercambio (0.15)
  5. Aplica elitismo (2 individuos)
  6. Continúa generación;

note right
    Fitness multiobjeto:
    - Distancia total (principal)
    - Tiempo de espera
    - Balanceo de paradas
    
    Puntos fijos:
    - Inicio: Universidad
    - Fin: Universidad
end note

:Retorna mejor ruta\ne historial de fitness;

:Construye respuesta JSON;
note right
    Contiene:
    - Ruta optimizada
    - Coordenadas
    - Geometría GeoJSON
    - Distancia total (km)
    - Historial fitness
    - Tiempo ejecución
end note

:Retorna 200 OK\ncon resultados al Frontend;

' === Frontend Display ===

:Frontend recibe resultados;

:Actualiza estado React\n(resultados, cargando);

:Muestra resultados en pantalla;
note right
    - Ruta en mapa (Leaflet)
    - Estadísticas de mejora
    - Gráfico del fitness
    - Orden de paradas
end note

:Usuario visualiza ruta\noptimizada en mapa;

:Usuario puede hacer clic en\n"Generar Análisis IA";

if (¿Usuario quiere análisis?) then (Sí)
    
    :Frontend envía request:\nPOST /api/analisis-ia;
    note right
        Datos enviados:
        - Resultados GA
        - Parámetros
        - Estadísticas
    end note
    
    :Backend construye prompt\ndetallado con contexto;
    
    :Envía prompt a\nGoogle Gemini 2.0 Flash;
    note right
        **NUEVO en v2.0**
        API: generative.google.com
        Requiere API key
    end note
    
    if (¿Gemini disponible?) then (Conexión OK)
        :Google Gemini procesa\nprompt con IA;
        
        :Genera análisis automático:\n- Resumen ejecutivo\n- Explicación del AG\n- Análisis de parámetros\n- Recomendaciones\n- Conclusiones;
        
        :Retorna análisis en Markdown\na Backend;
        
        :Backend formatea respuesta;
        
        :Retorna 200 OK con análisis\nal Frontend;
        
        :Frontend abre modal\ncon análisis;
        
        :Renderiza Markdown\ne interactivo;
        note right
            Características:
            - Copiar al portapapeles
            - Descargar como .md
            - Formatos: negrita, listas, código
        end note
        
    else (Sin conexión)
        :Muestra error;
        :Usuario puede reintentar;
    endif
    
else (No)
    note right
        Usuario omite análisis IA
    end note
endif

:Usuario puede exportar\nresultados (JSON, CSV);

:Usuario puede optimizar\notra ruta;

if (¿Otra optimización?) then (Sí)
    :Regresa al paso de\nselección de rutas;
else (No)
    :Usuario termina sesión;
    stop
endif

@enduml
