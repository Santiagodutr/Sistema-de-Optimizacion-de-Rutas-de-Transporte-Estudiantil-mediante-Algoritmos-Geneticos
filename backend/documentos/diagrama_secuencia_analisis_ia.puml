@startuml Secuencia - Análisis IA Detallado v2.0

participant Usuario as U
participant App as A
participant AIAnalysisModal as M
participant api_rutas_reales as API
participant genai.Client as GeminiAPI
participant renderMarkdown as Render

autonumber

U -> A: Hace clic en "Generar Análisis IA"
A -> A: setCargandoIA = true\nsetModalIAOpen = true

A -> M: Abre modal con spinner

A -> API: POST /api/analisis-ia\n{ruta, estadisticas}

API -> API: Obtiene GEMINI_API_KEY\nInicializa genai.Client

API -> API: Extrae datos:\n- nombre_ruta\n- paraderos\n- distancia_total\n- parametros_ga

API -> API: Construye prompt detallado:\n- Info ruta\n- Parámetros AG\n- Historial fitness\n- Solicitud análisis

API -> GeminiAPI: genai_client.models.generate_content(\nprompt, stream=True)

GeminiAPI -> GeminiAPI: Procesa con Gemini Flash
GeminiAPI -> GeminiAPI: Genera análisis:\n- Resumen ejecutivo\n- Análisis de parámetros\n- Recomendaciones\n- Conclusiones

GeminiAPI -> API: Retorna stream de tokens Markdown

API -> API: Acumula respuesta completa
API -> API: Formatea JSON:\n{\n  status: 'success',\n  analisis_markdown: '...',\n  timestamp: now\n}

API -> A: Retorna 200 OK + análisis

A -> A: Captura respuesta
A -> A: setAnalisisIA = response.data
A -> A: setCargandoIA = false

M -> M: Desaparece spinner
M -> Render: Llama renderMarkdown(analisis)

Render -> Render: Procesa Markdown:\n- Encabezados (##, ###)\n- Listas (-, *)\n- Código (```...```)\n- Negritas (**text**)

Render -> M: Retorna elementos JSX

M -> U: Renderiza análisis formateado

U -> M: Hace clic en "Copiar"

M -> M: navigator.clipboard\n.writeText(analisis)
M -> M: Muestra check durante 2 seg

U -> M: Hace clic en "Descargar"

M -> M: Crea blob:\nnew Blob([analisis],\n  {type: 'text/markdown'})
M -> M: Genera nombre:\nanalisis-ruta-{date}.md
M -> M: Dispara descarga

U -> M: Hace clic en X (onClose)

M -> A: setModalIAOpen = false
A -> U: Modal cerrado

note over U, GeminiAPI
    **Flujo del Análisis IA (v2.0):**
    
    1. App.js usuario inicia análisis
    2. AIAnalysisModal abre con cargando
    3. api_rutas_reales construye prompt
    4. genai.Client genera análisis
    5. renderMarkdown formatea resultado
    6. Usuario puede copiar/descargar
    
    **Componentes principales:**
    - App.js: Lógica principal
    - AIAnalysisModal: UI del modal
    - api_rutas_reales: Endpoint /api/analisis-ia
    - Google genai: Gemini Flash 2.0
    
    **Tiempo típico:** 3-5 segundos
end note

@enduml
